angular.module("Tjoys",["ui.router","ui.router.router","DelegateEvents"]).run(["$rootScope","$state","cachePool",function(e,t,n){e.Thumb="themes/img/thumb.jpg",e.UserInfo=function(){var e=n.pull("UserInfo");return e||(e={UserId:0}),e}(),e.$on("$stateChangeStart",function(n,a,r,o,i){return"mange.login"==a.name?void(e.showHeader=!1):void(e.UserInfo&&e.UserInfo.Auth?e.showHeader=!0:(e.showHeader=!1,n.preventDefault(),t.go("mange.login",{from:o.name,w:"notLogin"})))})}]).config(["$stateProvider","$urlRouterProvider",function(e,t){e.state("mange",{"abstract":!0,url:"/mange",templateUrl:"code/tp/main.html"}).state("mange.login",{url:"/login.htm",templateUrl:"code/tp/login.html",controller:"tLogin"}).state("mange.password",{url:"/password.htm",templateUrl:"code/tp/password.html",controller:"tPassword"}).state("mange.index",{url:"/index.htm",templateUrl:"code/tp/index.html",controller:"tIndex"}).state("mange.banner",{url:"/banner.htm",templateUrl:"code/tp/banner.html",controller:"tBanner"}).state("mange.banner-add",{url:"/banner/add.htm",templateUrl:"code/tp/banner_add.html",controller:"tBannerAdd"}).state("mange.feedback",{url:"/feedback.htm",templateUrl:"code/tp/feedback.html",controller:"tFeedback"}).state("mange.report",{url:"/report.htm",templateUrl:"code/tp/report.html",controller:"tReport"}).state("mange.cate",{url:"/cate.htm",templateUrl:"code/tp/cate.html",controller:"tCate"}).state("mange.list",{url:"/list.htm?type&cateid&page",templateUrl:"code/tp/list.html",controller:"tList"}).state("mange.list-detail",{url:"/list/detail/{id}.htm?type",templateUrl:"code/tp/list_detail.html",controller:"tListDetail"}).state("mange.subject",{url:"/subject.htm",templateUrl:"code/tp/subject.html",controller:"tSubject"}).state("mange.subject-content",{url:"/subject/content-{id}.htm",templateUrl:"code/tp/subject_content.html",controller:"tSubjectContent"}).state("mange.subject-add",{url:"/subject/add.htm",templateUrl:"code/tp/subject_add.html",controller:"tSubjectAdd"}).state("mange.activity",{url:"/activity.htm",templateUrl:"code/tp/activity.html",controller:"tActivity"}).state("mange.activity-add",{url:"/activity/add.htm",templateUrl:"code/tp/activity_add.html",controller:"tActivityAdd"}).state("mange.comment",{url:"/comment.htm",templateUrl:"code/tp/comment.html",controller:"tComment"}).state("mange.club",{url:"/club.htm",templateUrl:"code/tp/club.html",controller:"tClub"}).state("mange.club-add",{url:"/club/add.htm",templateUrl:"code/tp/club_add.html",controller:"tClubAdd"}).state("mange.club-thread",{url:"/club/thread-{id}.htm",templateUrl:"code/tp/club_thread.html",controller:"tClubThread"}).state("mange.user",{url:"/user.htm",templateUrl:"code/tp/user.html",controller:"tUser"}).state("mange.role",{url:"/role.htm",templateUrl:"code/tp/role.html",controller:"tRole"}).state("mange.role-add",{url:"/role/add.htm",templateUrl:"code/tp/role_add.html",controller:"tRoleAdd"}),t.otherwise("/mange/login.htm")}]),function(e){try{e=angular.module("Tjoys")}catch(t){e=angular.module("Tjoys",[])}e.run(["$templateCache",function(e){e.put("common/directives/city_list.html",'<section class="mod_city_list" ngd-click="toggleCity($event)" selector="dt">\n    <ul>\n        <li ng-click="cancleCity()">取消</li>\n        <li>{{City.tmpName}}</li>\n        <li ng-click="submitCity()">确定</li>\n    </ul>\n\n    <div ngd-click="selectCity($event)" selector="p">\n        <dl ng-repeat="(k, v) in CityList track by $index" ng-class="{open: v.id == City.tmpMid}">\n            <dt data-mid="{{v.id}}" data-mkey="{{k}}" data-name="{{v.name}}">{{v.name}}</dt>\n            <dd>\n                <p ng-repeat="(i, n) in v.sub track by $index" ng-class="{current: n.id == City.tmpSid}" data-sid="{{n.id}}" data-skey="{{k}}" data-name="{{n.name}}">\n                    {{n.name}}\n                </p>\n            </dd>\n        </dl>\n    </div>\n</section>')}])}(),function(e){try{e=angular.module("Tjoys")}catch(t){e=angular.module("Tjoys",[])}e.run(["$templateCache",function(e){e.put("common/directives/menu_bar.html",'<header ng-if="showHeader" class="mod_header">\n    <ul ngd-click="showMenu($event)" selector="li">\n        <li>\n            师乐汇\n        </li>\n        <li ng-class="{show: Menu == \'web\'}" ng-click="showSubmenu(\'web\')">\n            网站管理\n        </li>\n        <li ng-class="{show: Menu == \'article\'}" ng-click="showSubmenu(\'article\')">\n            内容管理\n        </li>\n        <li ng-class="{show: Menu == \'club\'}" ng-click="showSubmenu(\'club\')">\n            社区管理\n        </li>\n        <li ng-class="{show: Menu == \'user\'}" ng-click="showSubmenu(\'user\')">\n            用户管理\n        </li>\n<!--         <li ng-class="{show: Menu == \'mange\'}" ng-click="showSubmenu(\'mange\')">\n            客服管理\n        </li> -->\n    </ul>\n</header>')}])}(),function(e){try{e=angular.module("Tjoys")}catch(t){e=angular.module("Tjoys",[])}e.run(["$templateCache",function(e){e.put("common/directives/menu_sub_bar.html",'<div ng-if="showHeader" class="mod_menu">\n    <ul>\n        <li ng-class="{show: Menu == \'web\'}">\n            <dl>\n                <dt>营销管理</dd>\n                <dd><a ng-class="{current: SubMenu==\'banner\'}" ui-sref="mange.banner">广告管理</a></dd>\n                <!-- <dd><a ui-sref="mange.welcome">欢迎页管理</a></dd> -->\n                <dd><a ng-class="{current: SubMenu==\'msg\'}" ui-sref="mange.msg">消息群发</a></dd>\n                \n         <!--        <dt>个人设置</dd>\n                <dd><a ng-class="{current: SubMenu==\'password\'}" ui-sref="mange.password">修改密码</a></dd> -->\n                <dt>客服管理</dt>\n                <dd><a ng-class="{current: SubMenu==\'feedback\'}" ui-sref="mange.feedback">意见反馈</a></dd>\n                <!-- <dd><a ng-class="{current: SubMenu==\'report\'}" ui-sref="mange.report">举报管理</a></dd> -->\n            </dl>\n        </li>\n        <li ng-class="{show: Menu==\'article\'}">\n            <dl>\n                <dt>图片管理</dt>\n                <dd>\n                    <a ng-class="{current: SubMenu==\'list\'}" ui-sref="mange.list" ui-sref-opts="{inherit: false}">\n                        图片列表\n                    </a>\n                </dd>\n                <dd>\n                    <a ng-class="{current: SubMenu==\'list-no\'}" ui-sref="mange.list({type: \'no\'})" ui-sref-opts="{inherit: false}">\n                        未推荐\n                    </a>\n                </dd>\n                <dd>\n                    <a ng-class="{current: SubMenu==\'list-yes\'}" ui-sref="mange.list({type: \'yes\'})" ui-sref-opts="{inherit: false}">\n                        已推荐\n                    </a>\n                </dd>\n                <dd>\n                    <a ng-class="{current: SubMenu==\'list-home\'}" ui-sref="mange.list({type: \'home\'})" ui-sref-opts="{inherit: false}">\n                        首页图片\n                    </a>\n                </dd>\n\n                <dt>评论管理</dt>\n                <dd><a ng-class="{current: SubMenu==\'comment\'}" ui-sref="mange.comment">全部评论</a></dd>\n\n                <dt>其他管理</dt>\n                <dd><a ng-class="{current: SubMenu==\'cate\'}" ui-sref="mange.cate">标签管理</a></dd>\n            </dl>\n        </li>\n        <li ng-class="{show: Menu == \'club\'}">\n            <dl>\n                <dt>圈子管理</dt>\n                <dd><a ng-class="{current: SubMenu==\'club\'}" ui-sref="mange.club">圈子列表</a></dd>\n                <dd><a ng-class="{current: SubMenu==\'club-add\'}" ui-sref="mange.club-add">添加圈子</a></dd>\n                <dt>专题管理</dt>\n                <dd><a ng-class="{current: SubMenu==\'subject\'}" ui-sref="mange.subject">专题列表</a></dd>\n                <dd><a ng-class="{current: SubMenu==\'subject-add\'}" ui-sref="mange.subject-add">新建专题</a></dd>\n                <dt>活动管理</dt>\n                <dd><a ng-class="{current: SubMenu==\'activity\'}" ui-sref="mange.activity">活动列表</a></dd>\n                <dd><a ng-class="{current: SubMenu==\'activity-add\'}" ui-sref="mange.activity-add">创建活动</a></dd>\n            </dl>\n        </li>\n        <li ng-class="{show: Menu == \'user\'}">\n            <dl>\n                <dt>用户管理</dt>\n                <dd><a ng-class="{current: SubMenu==\'user\'}" ui-sref="mange.user">用户列表</a></dd>\n                <!-- <dd><a ui-sref="mange.login">等级列表</a></dd> -->\n\n                <dt>管理员管理</dt>\n                <dd><a ng-class="{current: SubMenu==\'role\'}" ui-sref="mange.role">管理员列表</a></dd>\n                <dd><a ng-class="{current: SubMenu==\'role-add\'}" ui-sref="mange.role-add">新增管理员</a></dd>\n            </dl>\n    </ul>\n</div>')}])}(),function(e){try{e=angular.module("Tjoys")}catch(t){e=angular.module("Tjoys",[])}e.run(["$templateCache",function(e){e.put("common/directives/show_page.html",'<ul ngd-click="changePage($event)" selector="li" class="mod_page mb10">\n    <li ng-repeat="(k, v) in [] | makeArr: PageNum" ng-class="{current: v == Page.pageIndex}">\n        {{v}}\n    </li>\n</ul>')}])}(),angular.module("Tjoys").factory("cachePool",function(){var e=function(e){if(!e)return null;var t,n=localStorage.getItem("tjoysadm"+e);try{t=JSON.parse(n)}catch(a){}return t?t:null},t=864e5,n={push:function(n,a,r){if(n&&a){var o=e(n)||{};o.value=a||void 0,o.expired=r?Date.now()+t*r:void 0,localStorage.setItem("tjoysadm"+n,JSON.stringify(o))}},pull:function(t){var n,a=e(t);return!a||a.expired&&a.expired<=Date.now()?null:n=a.value},remove:function(t,n){if(t){var a=e(t);return a?void(n&&a[n]?(a[n]=void 0,localStorage.setItem("tjoysadm"+t,JSON.stringify(a))):localStorage.removeItem("tjoysadm"+t)):void localStorage.removeItem("tjoysadm"+t)}},modify:function(t,n){if(t){var a,r=e(t);if(!r)return void localStorage.removeItem("tjoysadm"+t);if(n){for(a in r.value)n[a]&&(r.value[a]=n[a]);localStorage.setItem("tjoysadm"+t,JSON.stringify(r))}}}};return n}),angular.module("Tjoys").filter("ellipsis",function(){return function(e,t){return e&&t>0&&e.length>t?e.substring(0,t-2)+"…":e}}),angular.module("Tjoys").filter("specDate",["$filter",function(e){return function(t){var n=Date.now()-t,a="刚刚",r=36e5;return n>24*r?a=e("date")(t,"yyyy/MM/dd"):n>r&&(a=Math.floor(n/r)+"小时前"),a}}]),angular.module("Tjoys").filter("formatScore",function(){return function(e){return 10*Math.floor(e/.5)}}),angular.module("Tjoys").filter("makeArr",function(){return function(e,t,n){n=n||1;for(var a=1;t>=a;a+=n)e.push(a);return e}}),angular.module("Tjoys").config(["$provide","$httpProvider",function(e,t){e.factory("httpInterceptor",["$q",function(e){var t={request:function(t){t.url;return t||e.when(t)},requestError:function(t){return e.reject(t)},response:function(t){return t||e.when(t)},responseError:function(t){return e.reject(t)}};return t}]),t.interceptors.push("httpInterceptor")}]),angular.module("Tjoys").factory("widget",["$q","$http","$state","$compile","$timeout","$location","$rootScope","$cacheFactory","cachePool",function(e,t,n,a,r,o,i,l,c){var u=null,s=l("dataPool"),d={config:function(){var e={apiSocket:"http://m.tjoys.net:8092/mgapi/"};return e},msgToast:function(e,t){var n=angular.element(document.querySelector(".mod_msg"));if(!n.length){var o=a('<div class="mod_msg" ng-click="notification=null" ng-show="notification"><span>{{notification}}</span></div>');angular.element(document.getElementsByTagName("body")[0]).append(o(i))}r(function(){i.notification=e},0),r.cancel(u),u=r(function(){i.notification=""},t||2e3)},cacheData:function(e,t){if(!angular.isString(e))return!1;var n=s.get(e);return t?void s.put(e,t):n?n:!1},safeApply:function(e,t){e&&t&&(e.$$phase||e.$root&&e.$root.$$phase?t():e.$apply(t))},ajaxRequest:function(e){var n=this;if(e){var a=(e.scope||"",e.data||{}),r={Header:{UserId:"",Auth:""}};i.UserInfo&&i.UserInfo.UserId&&(r.Header.UserId=i.UserInfo.UserId,r.Header.Auth=i.UserInfo.Auth),a=angular.extend({},a,r);var o={success:function(){},error:function(){}},l={method:"POST",url:n.config().apiSocket+e.url||"",data:a,timeout:15e3};for(var c in e)o[c]=e[c];i.isLoading=!0,t(l).success(function(e){e.Response.State||n.cleanLogin(),e.Response&&"Success"==e.Response.Ack?("function"==typeof o.success&&o.success(e),i.isLoading=!1):(i.isLoading=!1,o.errmsg&&n.msgToast(o.errmsg))}).error(function(e){i.isLoading=!1,n.msgToast("网络错误，请稍后再试！"),o.error(e)})}},setLogin:function(e){c.push("UserInfo",{UserId:e.UserId,Auth:e.Auth},1),i.UserInfo=c.pull("UserInfo")},cleanLogin:function(){c.remove("UserInfo"),i.UserInfo={UserId:0}},checkPhone:function(e){var t=this,n=!1;return e||(t.msgToast("请输入手机号码"),n=!0),/^1[3|4|5|7|8][0-9]\d{4,8}$/.test(e)||(t.msgToast("手机号码格式不合法"),n=!0),n},getJobList:function(){var n=e.defer();return t({method:"GET",url:"data/getJobList.json",timeout:15e3}).success(function(e){n.resolve(e)}).error(function(e){n.reject(e)}),n.promise},getJobName:function(e){var t=this,n=t.getJobList().then(function(t){var n;return angular.forEach(t.JobList,function(t,a){t.Id==e&&(n=t.Name)}),n},function(e){return null});return n},getCityList:function(){var n=e.defer();return t({method:"GET",url:"data/getCityList.json",timeout:15e3}).success(function(e){n.resolve(e),i.CityList=e}).error(function(e){n.reject(e)}),n.promise},getCityName:function(e){var t,n=this;return i.CityList?angular.forEach(i.CityList,function(n,a){angular.forEach(n.sub,function(a,r){return a.id==e?void(t=n.name+" "+a.name):void 0}),t}):t=n.getCityList().then(function(t){var n;return angular.forEach(t,function(t,a){angular.forEach(t.sub,function(a,r){return a.id==e?void(n=t.name+" "+a.name):void 0}),n}),n},function(e){return null}),t}};return d}]),angular.module("Tjoys").directive("cityList",["$http","$state","$ionicViewSwitcher","$window","cachePool","widget","ENV",function(e,t,n,a,r,o,i){return{restrict:"E",replace:!0,templateUrl:"common/directives/city_list.html",controller:["$scope","$element","$rootScope","$compile","$timeout","widget",function(t,n,a,r,o,i){t.City||(t.City={}),t.City.tmpName||(t.City.tmpName="选择城市"),e({method:"GET",url:"data/getCityList.json",timeout:15e3}).success(function(e){t.CityList=e}),t.toggleCity=function(e){var n=angular.element(e.delegationTarget);return n.parent("dl").hasClass("open")?void(t.City.tmpMid=0):(t.City.tmpMname=n.attr("data-name"),void(t.City.tmpMid=n.attr("data-mid")))},t.selectCity=function(e){var n=angular.element(e.delegationTarget);t.City.tmpName=t.City.tmpMname+" "+n.attr("data-name"),t.City.tmpSid=n.attr("data-sid"),t.City.tmpCityId=t.City.tmpSid},t.cancleCity=function(e){t.City.tmpMid=0,t.City.tmpSid=0,t.City.tmpCityId=0,t.City.tmpName="选择城市",t.styleScroll={"overflow-y":"auto"},t.hideCity()},t.submitCity=function(e){return t.City.tmpCityId?(t.cInput.Area=t.City.tmpCityId,t.cInput.AreaName=t.City.tmpName,t.Page||(t.Page={}),t.Page.isModify=!0,void t.hideCity()):void i.msgToast("请选择您所在的位置！")},t.showCity=function(){n.css("display","block");t.styleScroll={"overflow-y":"hidden"},o(function(){n.addClass("this_show")},50)},t.hideCity=function(){n.removeClass("this_show")},t.choiceCity=function(){return t.CityList&&0!=t.CityList.length?(angular.forEach(t.CityList,function(e,n){angular.forEach(e.sub,function(n,a){n.id==t.cInput.Area&&(t.City.tmpMid=e.id,t.City.tmpMname=e.name)})}),t.City.tmpSid=t.cInput.Area,t.City.tmpCityId=t.cInput.Area,t.City.tmpName=t.cInput.AreaName,void t.showCity()):void i.msgToast("网络错误，请稍后再试！")}}]}}]),function(){var e=document.documentElement,t=e.matches||e.matchesSelector||e.webkitMatchesSelector||e.mozMatchesSelector||e.msMatchesSelector||e.oMatchesSelector,n=function(e,n){return t?t.call(e,n):e.tagName.toLowerCase()===n},a=function(t,a,r){for(r||(r=e);t&&t!=r&&r.contains(t);){if(n(t,a))return t;t=t.parentNode}return null},r={};e.contains||(Node.prototype.contains=function(e){return!!(16&this.compareDocumentPosition(e))});var o=/^\s*?{.+}\s*?$/;angular.forEach("Event Click Dblclick Mousedown Mouseup Mouseover Mouseout Mousemove Mouseenter Mouseleave".split(" "),function(e){var t="ngd"+e;r[t]=["$parse",function(n){return function(r,i,l){function c(e,t){var o=n(e);i.on(t,function(e){var n,l=e.target;(n=a(l,"string"==typeof u?u:u[t],i[0]))&&(e.delegationTarget=n,o(angular.element(n).scope(),{$event:e,$params:[].slice.call(arguments,1)}),r.$$phase||r.$apply())})}var u=l.selector,s="Event"==e?l.eventName||"click":e.toLowerCase(),d=l[t];u.match(o)&&(u=r.$eval(u)),d.match(o)?(d=r.$eval(d),angular.forEach(d,c)):c(d,s)}}]}),angular.module("DelegateEvents",[]).directive(r)}(),angular.module("Tjoys").directive("headerBar",["$window","$rootScope",function(e,t){return{restrict:"E",replace:!0,templateUrl:"common/directives/menu_bar.html",controller:["$scope","$element","$attrs",function(e,n,a){t.Header={subMenu:"web"},t.showSubmenu=function(e){t.Menu=e}}]}}]).directive("menuBar",["$window",function(e){return{restrict:"E",replace:!0,templateUrl:"common/directives/menu_sub_bar.html",controller:["$scope","$element","$attrs",function(e,t,n){}]}}]),angular.module("Tjoys").directive("appFilereader",["$q","$parse","widget",function(e,t,n){var a=Array.prototype.slice;return{restrict:"A",require:"?ngModel",link:function(t,r,o,i){i&&(i.$render=function(){},r.bind("change",function(r){function o(t){var n=e.defer(),a=new FileReader;return a.onload=function(e){n.resolve(e.target.result)},a.onerror=function(e){n.reject(e)},a.readAsDataURL(t),n.promise}function l(e){var t=angular.element(document.querySelector("#tmp"))[0],n=t.getContext("2d"),a=new Image;a.onload=function(){EXIF.getData(a,function(){var e=EXIF.pretty(this),r=e?e.Orientation:1;n.drawImage(a,0,0);var o=new MegaPixImage(a);o.render(t,{maxWidth:1e3,quality:1,orientation:r},function(){var e=t.toDataURL("image/jpeg");i.$setViewValue(e)})})},a.src=e}var c=r.target;e.all(a.call(c.files,0).map(o)).then(function(e){e&&0!=e.length&&(c.multiple?angular.forEach(e,function(e,t){l(e)}):l(e[0]),n.cacheData("CameraImages",t.CameraImages))})}))}}}]),angular.module("Tjoys").directive("pageBack",["$state","$window","$rootScope","$stateParams","$ionicHistory","$ionicViewSwitcher","widget",function(e,t,n,a,r,o,i){return{restrict:"A",link:function(e,t,n){t.on("click",function(){i.toBack()})}}}]).directive("pageJump",["$window","$state","$rootScope","$stateParams","$ionicHistory","$ionicViewSwitcher",function(e,t,n,a,r,o){return{restrict:"A",link:function(e,n,a){n.on("click",function(n){var i="forward";"none"==a.pageJump&&(i="none",e.loadMore={},r.clearCache(),r.clearHistory());var l=a.router,c=a.options?e.$eval(a.options):{};o.nextDirection(i),t.go(l,c,{inherit:!1})})}}}]),angular.module("Tjoys").directive("showPage",["$window","$rootScope",function(e,t){return{restrict:"E",replace:!0,templateUrl:"common/directives/show_page.html",controller:["$scope","$element","$attrs",function(e,t,n){e.changePage=function(t){var n=angular.element(t.delegationTarget);id=parseInt(n.text(),0),e.Page.pageIndex=id,e.Page.isAll=!1,e.loadMore()},e.$watch("DataList.Total",function(){e.DataList.Total&&(e.PageNum=Math.ceil(e.DataList.Total/e.Page.pageSize))})}]}}]);